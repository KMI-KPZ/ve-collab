name: Test and Deploy

# run on push to staging (includes when PR is merged) and test_deploy (testing of this script) or when manually triggered
on:
  push:
    branches: [ "staging", "test_deploy"]
  workflow_dispatch:

jobs:
  test:
    # run tests first using reusable workflow test_caller, if tests fail, deploy job won't run
    uses: ./.github/workflows/test_caller.yml
    secrets:
      CONFIG: ${{ secrets.CONFIG }}
      MONGODB_USERNAME: ${{ secrets.MONGODB_USERNAME }}
      MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}

  deploy:
    name: deploy to staging
    runs-on: ubuntu-latest
    steps:
    - name: trigger deploy workflow webhook
      uses: distributhor/workflow-webhook@v3.0.5
      env:
        webhook_url: ${{ secrets.WEBHOOK_URL }}
        webhook_auth: ${{ secrets.WEBHOOK_AUTH }}
